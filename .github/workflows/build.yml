name: Build Packages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      noarch: ${{ steps.generate-matrix.outputs.noarch }}
      multiarch: ${{ steps.generate-matrix.outputs.multiarch }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate package matrix
        id: generate-matrix
        run: |
          noarch_packages=$(for pkg in packages/*/APKBUILD; do
            if grep -q '^arch="noarch"' "$pkg"; then
              basename $(dirname "$pkg")
            fi
          done | jq -R -s -c 'split("\n") | map(select(length > 0))')

          multiarch_packages=$(for pkg in packages/*/APKBUILD; do
            if grep -qE '^arch="(aarch64|armv7|aarch64 armv7)"' "$pkg"; then
              basename $(dirname "$pkg")
            fi
          done | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "noarch=$noarch_packages" >> $GITHUB_OUTPUT
          echo "multiarch=$multiarch_packages" >> $GITHUB_OUTPUT

  build-noarch:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.setup.outputs.noarch) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up signing key
        run: |
          if [ -n "${{ secrets.SIGNING_KEY }}" ]; then
            echo "${{ secrets.SIGNING_KEY }}" > keys/packages.rsa
            chmod 600 keys/packages.rsa
          fi

      - name: Build ${{ matrix.package }}
        run: ./scripts/build-package.sh "${{ matrix.package }}" aarch64

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-noarch-${{ matrix.package }}
          path: dist/
          if-no-files-found: warn

  build-multi-arch:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.setup.outputs.multiarch) }}
        arch: [aarch64, armv7]

    steps:
      - uses: actions/checkout@v4

      - name: Set up signing key
        run: |
          if [ -n "${{ secrets.SIGNING_KEY }}" ]; then
            echo "${{ secrets.SIGNING_KEY }}" > keys/packages.rsa
            chmod 600 keys/packages.rsa
          fi

      - name: Build ${{ matrix.package }} for ${{ matrix.arch }}
        run: ./scripts/build-package.sh "${{ matrix.package }}" "${{ matrix.arch }}"

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.package }}-${{ matrix.arch }}
          path: dist/
          if-no-files-found: warn

  index:
    needs: [build-noarch, build-multi-arch]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Flatten package structure
        run: |
          mkdir -p dist/aarch64 dist/armv7
          find dist -name "*.apk" -path "*/aarch64/*" -exec mv {} dist/aarch64/ \;
          find dist -name "*.apk" -path "*/armv7/*" -exec mv {} dist/armv7/ \;
          rm -rf dist/packages

      - name: Set up signing key
        run: |
          if [ -n "${{ secrets.SIGNING_KEY }}" ]; then
            echo "${{ secrets.SIGNING_KEY }}" > keys/packages.rsa
            chmod 600 keys/packages.rsa
          fi

      - name: Generate and sign APKINDEX
        run: |
          for arch in aarch64 armv7; do
            ARCH_DIR="dist/$arch"
            if [ -d "$ARCH_DIR" ] && ls "$ARCH_DIR"/*.apk >/dev/null 2>&1; then
              echo "Generating APKINDEX for $arch..."
              docker run --rm \
                -v "$PWD/$ARCH_DIR:/packages:Z" \
                -v "$PWD/keys:/keys:ro" \
                -w /packages \
                alpine:edge \
                sh -c "
                  apk add --no-cache apk-tools abuild
                  cp /keys/packages.rsa.pub /etc/apk/keys/
                  apk index -o APKINDEX.tar.gz *.apk
                  abuild-sign -k /keys/packages.rsa APKINDEX.tar.gz
                  chown $(id -u):$(id -g) APKINDEX.tar.gz
                "
            fi
          done

      - name: Upload repository
        uses: actions/upload-artifact@v4
        with:
          name: repository
          path: dist/

  deploy:
    needs: index
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Download repository
        uses: actions/download-artifact@v4
        with:
          name: repository
          path: dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-2

      - name: Sync to S3
        run: |
          aws s3 sync dist/ s3://packages.vellum.delivery/ --delete
